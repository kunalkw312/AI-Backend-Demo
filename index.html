<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediGuide - AI Backend Demo</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Poppins Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    
    <style>
        /* Define custom colors and styles from our MediGuide app */
        body {
            font-family: 'Poppins', sans-serif;
            --primary-color: #01796F;
            --light-bg: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #1a1a2e;
            --console-bg: #2b2b2b;
            --console-text: #00ff00;
        }
        /* Custom Tailwind colors */
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .hover\:bg-primary-dark:hover { background-color: #043927; }

        /* Console styling */
        #console-output {
            background-color: var(--console-bg);
            color: var(--console-text);
            font-family: "Courier New", monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div class="container mx-auto max-w-6xl p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- === APPLICATION COLUMN === -->
            <div class="app-column">
                <div class="card bg-white rounded-lg shadow-lg p-6">
                    
                    <!-- Login View -->
                    <div id="login-view">
                        <h1 class="text-2xl font-bold text-primary mb-2">MediGuide AI Backend Demo</h1>
                        <p class="text-gray-600">Enter a username to simulate logging in and loading your personal health history.</p>
                        
                        <label for="username" class="block text-sm font-medium text-gray-700 mt-4">Username</label>
                        <input type="text" id="username" value="JohnDoe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        
                        <button id="login-button" class="mt-4 w-full bg-primary text-white py-2 px-4 rounded-md font-semibold hover:bg-primary-dark">
                            Login & Load History
                        </button>
                    </div>

                    <!-- Main App View (Hidden) -->
                    <div id="app-view" class="hidden">
                        <h2 id="welcome-header" class="text-xl font-bold text-primary"></h2>
                        
                        <h3 class="text-lg font-semibold text-gray-800 mt-4">Your Symptom History</h3>
                        <ul id="user-history-list" class="text-sm text-gray-600 list-none p-2 mt-2 border rounded-md max-h-32 overflow-y-auto">
                            <li>No history found.</li>
                        </ul>

                        <form id="symptom-form" class="mt-4">
                            <label for="symptoms" class="block text-sm font-medium text-gray-700">Enter Today's Symptoms</label>
                            <textarea id="symptoms" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" rows="3">I have a fever and a bad headache</textarea>
                            
                            <label for="medical-history" class="block text-sm font-medium text-gray-700 mt-4">Medical History (Optional)</label>
                            <input type="text" id="medical-history" value="Seasonal allergies" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                            
                            <button type="submit" id="submit-button" class="mt-6 w-full bg-primary text-white py-2 px-4 rounded-md font-semibold hover:bg-primary-dark disabled:bg-gray-400">
                                Get Recommendation
                            </button>
                        </form>

                        <h3 class="text-lg font-semibold text-gray-800 mt-6">AI Recommendation:</h3>
                        <div id="recommendation-output" class="p-4 mt-2 bg-teal-50 border border-teal-200 text-teal-800 rounded-md min-h-[50px]">
                            Your personalized recommendation will appear here...
                        </div>
                    </div>

                </div>
            </div>

            <!-- ===  BACKEND COLUMN === -->
            <div class="backend-column">
                <div class="card bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-primary"> Backend Log</h2>
                    <pre id="console-output" class="p-4 mt-4 text-sm rounded-md h-[500px] overflow-y-auto">> Waiting for user login...</pre>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Get all our HTML elements ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginButton = document.getElementById('login-button');
        const usernameInput = document.getElementById('username');
        const symptomForm = document.getElementById('symptom-form');
        const symptomsInput = document.getElementById('symptoms');
        const historyInput = document.getElementById('medical-history');
        const welcomeHeader = document.getElementById('welcome-header');
        const historyList = document.getElementById('user-history-list');
        const recommendationOutput = document.getElementById('recommendation-output');
        const consoleOutput = document.getElementById('console-output');
        const submitButton = document.getElementById('submit-button');

        let currentUsername = "";
        let userHistory = []; // Our " database" in memory

        /**
         * A helper function to log messages to our " Backend" console
         */
        function log(message) {
            console.log(message); // Log to the real F12 console
            consoleOutput.textContent += `> ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight; // Auto-scroll
        }

        /**
         * A helper function to simulate a network delay
         */
        function Delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Renders the user's history from memory to the screen
         */
        function renderHistory() {
            historyList.innerHTML = ''; // Clear the list
            if (userHistory.length === 0) {
                historyList.innerHTML = '<li class="italic">No history found.</li>';
                return;
            }
            // Show most recent first
            [...userHistory].reverse().forEach(record => {
                const li = document.createElement('li');
                li.textContent = `[${record.date}] Symptoms: ${record.symptoms}`;
                li.className = "pb-2 mb-2 border-b border-gray-100 last:border-b-0";
                historyList.appendChild(li);
            });
        }

        /**
         * Handles the login button click
         */
        loginButton.addEventListener('click', async () => {
            currentUsername = usernameInput.value.trim();
            if (currentUsername.length === 0) {
                alert("Please enter a username.");
                return;
            }

            log(`--- NEW SESSION ---`);
            log(`Login request for user: '${currentUsername}'`);
            
            //  BACKEND: Check database (localStorage)
            log(`Querying database for user history...`);
            await Delay(1000); // Simulate network call to DB
            
            const historyKey = `mediguide_history_${currentUsername}`;
            const storedHistory = localStorage.getItem(historyKey);

            if (storedHistory) {
                userHistory = JSON.parse(storedHistory);
                log(`✅ Success: Found ${userHistory.length} past records for '${currentUsername}'.`);
            } else {
                userHistory = [];
                log(`INFO: No history found. A new profile will be created.`);
            }

            // Update UI
            welcomeHeader.textContent = `Welcome, ${currentUsername}!`;
            renderHistory();
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            log(`--- User Authenticated. Ready for input. ---`);
        });

        // ===================================================================
        // === START OF AI INTEGRATION ===
        // ===================================================================

        /**
         * Calls with our personalized prompt.
         */
        async function callGeminiAPI(augmentedPrompt) {
            log(`3. Sending request to Generative AI...`);
            
            // This is the JSON structure we want the AI to return
            const schema = {
                type: "OBJECT",
                properties: {
                    "diagnosis": { "type": "STRING" },
                    "recommendation": { "type": "STRING" }
                },
                required: ["diagnosis", "recommendation"]
            };

            // ========================================================
            // == ⬇️ This is your API Key ⬇️ ==
            // ========================================================
            const apiKey = "AIzaSyAJXz6E8Yi2KFXeMlZp_DPkf0a9oNo2qhw";
            // ========================================================

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: augmentedPrompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            // Exponential backoff for retries
            let response;
            let retries = 3;
            let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        log(`4. AI Response Received.`);
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (jsonText) {
                            return JSON.parse(jsonText); // Success!
                        } else {
                            throw new Error("Invalid JSON response from API.");
                        }
                    } else {
                        const errorData = await response.json();
                        let errorMsg = errorData.error.message;
                        log(`...API Error: ${response.status} ${errorMsg}`);
                        
                        // This check is CRITICAL for GitHub Pages
                        if (response.status === 403 && errorMsg.includes("permission")) {
                             log("...Visit Google AI Studio to authorize your GitHub domain.");
                        }
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    log(`...AI call failed (Attempt ${i+1}/${retries}): ${error.message}`);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        log(`❌ CRITICAL: AI call failed after ${retries} attempts.`);
                        return null; // Return null on final failure
                    }
                }
            }
        }


        /**
         * Handles the symptom form submission
         */
        symptomForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Stop the page from reloading
            submitButton.disabled = true; // Disable button during processing
            submitButton.textContent = "Analyzing...";

            const symptoms = symptomsInput.value.trim();
            const history = historyInput.value.trim();
            
            if (symptoms.length === 0) {
                alert("Please enter your symptoms.");
                submitButton.disabled = false;
                submitButton.textContent = "Get Recommendation";
                return;
            }

            log(`--- NEW SUBMISSION ---`);
            log(`Received input: "${symptoms}"`);
            log(`Medical History: "${history}"`);

            // --- 1. "Personalized AI Engine" -  History Analysis ---
            log(`1. Analyzing user history for patterns...`);
            await Delay(750);
            
            let historyAnalysis = "User has no significant past history.";
            if (userHistory.some(record => record.symptoms.toLowerCase().includes("headache"))) {
                historyAnalysis = "User frequently reports headaches.";
            } else if (userHistory.some(record => record.symptoms.toLowerCase().includes("cough"))) {
                historyAnalysis = "User has a recent history of coughing.";
            }

            log(`...Analysis complete: ${historyAnalysis}`);
            
            // --- 2. Create the Personalized Prompt (as described in your doc) ---
            log(`2. Augmenting prompt for Generative AI...`);
            
            const systemPrompt = `You are a medical assistant. 
            First, analyze the user's history and current symptoms.
            Then, provide a brief, one-sentence diagnosis and a 1-2 sentence recommendation.
            If their history is relevant (e.g., they report headaches often and have one now),
            mention this in the recommendation.
            
            Here is the data:
            - User's Past History Summary: ${historyAnalysis}
            - User's Stated Medical Conditions: ${history || "None"}
            - User's Current Symptoms: "${symptoms}"`;

            log(`...Augmented Prompt created.`);
            
            // --- 3. Call the AI ---
            const aiResponse = await callGeminiAPI(systemPrompt);

            let diagnosis, recommendation;

            if (aiResponse) {
                // Use REAL AI response
                diagnosis = aiResponse.diagnosis;
                recommendation = aiResponse.recommendation;
                log(`... AI Diagnosis: ${diagnosis}`);
            } else {
                // Fallback if AI fails
                log(`...AI FAILED. Using simple fallback.`);
                diagnosis = "General Symptoms";
                recommendation = "Could not reach AI. Please monitor symptoms and rest. If they worsen, see a doctor.";
            }
            
            recommendationOutput.innerHTML = `<strong class="block">${diagnosis}</strong> ${recommendation}`;

            // --- 4. "SAVE" to  Database ---
            log(`5. Saving new record to database...`);
            
            const newRecord = {
                date: new Date().toLocaleDateString(),
                symptoms: symptoms,
                diagnosis: diagnosis // Save the real diagnosis
            };
            userHistory.push(newRecord);

            // Save to localStorage
            const historyKey = `mediguide_history_${currentUsername}`;
            localStorage.setItem(historyKey, JSON.stringify(userHistory));

            await Delay(500);
            log(`...Save complete.`);
            log(`--- Process Finished. ---`);

            // Update the history list on screen and re-enable button
            renderHistory();
            submitButton.disabled = false;
            submitButton.textContent = "Get Recommendation";
        });

    </script>

</body>

</html>

